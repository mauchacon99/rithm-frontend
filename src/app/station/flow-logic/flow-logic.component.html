<ng-container *ngIf="!flowLogicView; else newView">
  <div
    class="h-full w-full"
    *ngIf="nextStations.length; else notConnectedStations"
  >
    <div *ngIf="ruleError">
      <p class="text-center text-error-500" id="rules-error">
        Error: Unable to retrieve the flow rules.
      </p>
    </div>
    <div
      *ngIf="ruleLoading"
      class="flex w-full items-center justify-center py-16"
      id="rule-loading"
    >
      <app-loading-indicator></app-loading-indicator>
    </div>
    <section *ngIf="!ruleLoading && !ruleError">
      <div
        *ngFor="let station of nextStations; let i = index"
        class="flex flex-col justify-start"
      >
        <div class="mb-6">
          <p class="font-semibold mt-10">{{ station.name }} Rules</p>
          <!-- Loader for flow logic -->
          <div
            *ngIf="flowLogicLoading"
            class="flex justify-start"
            id="flow-logic-loading"
          >
            <app-loading-indicator
              [inlineText]="'Loading...'"
            ></app-loading-indicator>
          </div>
          <div *ngIf="!flowLogicLoading && !flowRuleError">
            <p
              class="text-error-500 mt-4"
              [id]="'there-are-not-rules-' + i"
              *ngIf="
                !getStationFlowRules(station.rithmId).equations.length &&
                !getStationFlowRules(station.rithmId).subRules.length
              "
            >
              Documents will always flow here if there are no rules.
            </p>
            <div>
              <section class="all-rules">
                <p class="mt-3">
                  Flow to {{ station.name }} if ALL of the following are true.
                </p>
                <section
                  *ngIf="
                    flowLogicLoadingByRuleType !== station.rithmId + '-all';
                    else flowLogicRuleLoading
                  "
                >
                  <div
                    class="flex justify-between items-center border-b border-secondary-100"
                    *ngFor="
                      let equation of getStationFlowRules(station.rithmId)
                        .equations;
                      let j = index
                    "
                  >
                    <p
                      class="flex flex-col items-start sm:flex-row sm:items-end py-2 pl-3 text-secondary-500"
                    >
                      {{ equation.leftOperand.text | titlecase }}
                      <span class="font-semibold px-2">
                        {{ translateOperator(equation.operatorType) }}</span
                      >
                      {{ equation.rightOperand.text }}
                    </p>
                    <figure class="flex">
                      <button
                        attr.data-testid="edit-rule-button-all-{{
                          station.rithmId
                        }}-{{ j }}"
                        id="edit-rule-button-all-{{ station.rithmId }}-{{ j }}"
                        type="button"
                        mat-icon-button
                        matSuffix
                        matTooltip="Edit current rule"
                        (click)="openModal('all', station.rithmId, equation, j)"
                      >
                        <i class="fas fa-pen text-secondary-300 text-base"></i>
                      </button>
                      <button
                        type="button"
                        mat-icon-button
                        matSuffix
                        id="delete-rule-button-all-{{ station.rithmId }}-{{
                          j
                        }}"
                        attr.data-testid="delete-rule-button-all-{{
                          station.rithmId
                        }}-{{ j }}"
                        matTooltip="Remove current rule"
                        (click)="
                          deleteRuleFromStationFlowLogic(
                            j,
                            'all',
                            station.rithmId
                          )
                        "
                      >
                        <i
                          class="fas fa-trash text-secondary-300 text-base"
                        ></i>
                      </button>
                    </figure>
                  </div>
                </section>
                <div class="mt-4">
                  <button
                    mat-stroked-button
                    type="button"
                    (click)="openModal('all', station.rithmId)"
                    attr.data-testid="all-new-rule-{{ station.rithmId }}"
                    id="all-new-rule-{{ station.rithmId }}"
                    class="px-4 py-1 rounded border-solid border-2 border-primary-200 text-accent-500 text-sm font-semibold"
                  >
                    New Rule
                  </button>
                </div>
              </section>
              <div class="mt-5">
                <span>- OR -</span>
              </div>
              <section class="any-rules">
                <p>
                  Flow to {{ station.name }} if ANY of the following are true.
                </p>
                <section
                  *ngIf="
                    flowLogicLoadingByRuleType !== station.rithmId + '-any';
                    else flowLogicRuleLoading
                  "
                >
                  <div
                    class="flex justify-between items-center border-b border-secondary-100"
                    *ngFor="
                      let subRule of getStationFlowRules(station.rithmId)
                        .subRules;
                      let k = index
                    "
                  >
                    <p
                      class="flex flex-col items-start sm:flex-row sm:items-end py-2 pl-3 text-secondary-500"
                    >
                      {{ subRule.equations[0].leftOperand.text | titlecase }}
                      <span class="font-semibold px-2">
                        -
                        {{
                          translateOperator(subRule.equations[0].operatorType)
                        }}
                        -</span
                      >
                      {{ subRule.equations[0].rightOperand.text | titlecase }}
                    </p>
                    <figure class="flex">
                      <button
                        attr.data-testid="edit-rule-button-any-{{
                          station.rithmId
                        }}-{{ k }}"
                        id="edit-rule-button-any-{{ station.rithmId }}-{{ k }}"
                        type="button"
                        mat-icon-button
                        matSuffix
                        matTooltip="Edit current rule"
                        (click)="
                          openModal(
                            'any',
                            station.rithmId,
                            subRule.equations[0],
                            k
                          )
                        "
                      >
                        <i class="fas fa-pen text-secondary-300 text-base"></i>
                      </button>
                      <button
                        type="button"
                        mat-icon-button
                        matSuffix
                        id="delete-rule-button-any-{{ station.rithmId }}-{{
                          k
                        }}"
                        attr.data-testid="delete-rule-button-any-{{
                          station.rithmId
                        }}-{{ k }}"
                        matTooltip="Remove current rule"
                        (click)="
                          deleteRuleFromStationFlowLogic(
                            k,
                            'any',
                            station.rithmId
                          )
                        "
                      >
                        <i
                          class="fas fa-trash text-secondary-300 text-base"
                        ></i>
                      </button>
                    </figure>
                  </div>
                </section>
                <div class="mt-4">
                  <button
                    mat-stroked-button
                    type="button"
                    (click)="openModal('any', station.rithmId)"
                    attr.data-testid="any-new-rule-{{ station.rithmId }}"
                    id="any-new-rule-{{ station.rithmId }}"
                    class="px-4 py-1 mt-4 rounded border-solid border-2 border-primary-200 text-accent-500 text-sm font-semibold"
                  >
                    New Rule
                  </button>
                </div>
              </section>
            </div>
          </div>
          <!-- Error in rules flow logic -->
          <div *ngIf="flowRuleError" id="flow-logic-rules-error">
            <p class="text-left text-error-500">
              Error: Unable to retrive station rules.
            </p>
          </div>
        </div>
      </div>
    </section>
  </div>
  <ng-template #flowLogicRuleLoading>
    <div class="flex justify-left" id="flow-logic-loading-rules">
      <app-loading-indicator
        [inlineText]="'Loading...'"
      ></app-loading-indicator>
    </div>
  </ng-template>
  <ng-template #notConnectedStations>
    <div class="w-100 mt-10">
      <p class="text-center text-error-500">
        There are not any forward connections, please make a connection in order
        to add flow logic.
      </p>
    </div>
  </ng-template>
</ng-container>

<ng-template #newView>
  <div class="flex h-full">
    <aside class="rules-left-side p-4 min-w-[266px]">
      <ul class="rules-left-side-menu border-b border-secondary-100">
        <li
          class="py-2 cursor-pointer"
          [ngClass]="{ 'text-accent-500': ruleSelectedMenu === 'triggers' }"
          (click)="ruleSelectedMenu = 'triggers'"
        >
          <i class="fa-regular fa-clock"></i> Station Triggers
        </li>
        <li
          class="py-2 cursor-pointer"
          [ngClass]="{ 'text-accent-500': ruleSelectedMenu === 'rules' }"
          (click)="ruleSelectedMenu = 'rules'"
        >
          <i class="fa-regular fa-square-plus"></i> New Rule
        </li>
      </ul>
      <ul class="rules-left-side-added-rules"></ul>
    </aside>
    <div
      class="rules-right-side w-full border-l border-secondary-100 overflow-hidden"
    >
      <section class="rules-right-side-title w-full">
        <div class="py-6 pr-6 pl-8 flex justify-between items-center">
          <p
            class="tracking-tight text-xl font-semibold"
            *ngIf="ruleSelectedMenu === 'rules'"
          >
            Untitled Rule
            <i class="fa-solid fa-pencil text-xl ml-1 cursor-pointer"></i>
          </p>
          <p
            class="tracking-tight text-xl font-semibold"
            *ngIf="ruleSelectedMenu === 'triggers'"
          >
            Station Triggers
          </p>
          <button mat-icon-button>
            <i class="fa-solid fa-ellipsis"></i>
          </button>
        </div>
      </section>
      <section class="rules-right-side-triggers w-full">
        <div
          class="title h-14 flex justify-between items-center bg-secondary-50 pl-8 pr-6"
        >
          <p class="tracking-tight text-sm">
            {{ ruleSelectedMenu === 'triggers' ? 'STANDARD ' : '' }}TRIGGERS
          </p>
        </div>
        <div
          class="title h-14 flex justify-between items-center border-b border-secondary-50 pl-8 pr-6"
        >
          <p class="tracking-tight text-sm">
            Manually Flow
            <i
              class="fa-solid fa-circle-question text-secondary-200 text-xl ml-1"
              [matTooltip]="manuallyTooltip"
              [matTooltipPosition]="'right'"
            ></i>
          </p>
          <mat-slide-toggle></mat-slide-toggle>
        </div>
        <div
          class="title h-14 flex justify-between items-center border-b border-secondary-50 pl-8 pr-6"
        >
          <p class="tracking-tight text-sm">
            Check container
            {{ ruleSelectedMenu === 'triggers' ? 'only on ' : 'on' }} arrival
          </p>
          <mat-slide-toggle></mat-slide-toggle>
        </div>
        <div
          class="title h-14 flex justify-between items-center border-b border-secondary-50 pl-8 pr-6"
        >
          <p class="tracking-tight text-sm">
            Check all containers on
            {{ ruleSelectedMenu === 'triggers' ? 'new ' : '' }} container
            arrival
          </p>
          <mat-slide-toggle></mat-slide-toggle>
        </div>
        <div
          class="title h-14 flex justify-between items-center border-b border-secondary-50 pl-8 pr-6"
        >
          <p class="tracking-tight text-sm">
            Check all
            {{ ruleSelectedMenu === 'triggers' ? 'on ' : '' }} containers on
            container departure
          </p>
          <mat-slide-toggle></mat-slide-toggle>
        </div>
        <div
          class="title flex items-center border-b border-secondary-50 pl-8 pr-6 pt-8 pb-10"
          *ngIf="ruleSelectedMenu === 'rules'"
        >
          <button mat-stroked-button color="accent">Add Trigger</button>
        </div>
      </section>
      <section
        class="rules-right-side-schedule w-full"
        *ngIf="ruleSelectedMenu === 'triggers'"
      >
        <div
          class="title h-14 flex justify-between items-center bg-secondary-50 pl-8 pr-6 mt-5"
        >
          <p class="tracking-tight text-sm">SCHEDULED TRIGGERS</p>
        </div>
        <div class="flex justify-center items-center flex-col text-center mb-6">
          <i class="far fa-clock text-4xl text-accent-500 mt-6"></i>
          <p class="py-4 w-5/6 md:w-2/4 text-sm">
            Schedule triggers can be configured to check conditions and flow
            documents automatically
          </p>
          <button
            mat-stroked-button
            data-testid="button-addTrigger-schedule"
            color="accent"
          >
            Add Trigger
          </button>
        </div>
      </section>
      <section
        *ngIf="ruleSelectedMenu === 'rules'"
        class="rules-right-side-conditions w-full"
      >
        <div
          class="title h-14 flex justify-between items-center bg-secondary-50 pl-8 pr-6"
        >
          <p class="tracking-tight text-sm">CONDITIONS</p>
          <div class="select-condition">
            <mat-form-field appearance="outline">
              <mat-label> Condition Requirement </mat-label>
              <mat-select [(ngModel)]="selectedConditionType">
                <mat-option value="all"> All must be true </mat-option>
                <mat-option value="any"> Any must be true </mat-option>
              </mat-select>
            </mat-form-field>
          </div>
        </div>
        <section
          class="condition w-full py-6"
          *ngIf="!openFormCondition; else displayFormCondition"
        >
          <div class="condition-view-preview" *ngIf="!flowLogicRules.length">
            <div class="condition-view-preview-icon flex justify-center">
              <i class="fa-solid fa-clipboard-list text-accent-500 fa-3x"></i>
            </div>
            <div class="condition-view-preview-description flex justify-center">
              <p class="w-1/2 text-center text-sm py-4">
                Conditions check the value saved on the container the trigger
                actions
              </p>
            </div>
          </div>
          <div
            class="button-add-condition flex"
            [ngClass]="[
              flowLogicRules.length ? 'justify-start pl-8' : 'justify-center'
            ]"
          >
            <button
              mat-stroked-button
              data-testid="add-condition"
              color="accent"
              (click)="openFormCondition = true"
            >
              Add Condition
            </button>
          </div>
        </section>
        <ng-template #displayFormCondition>
          <section class="add-condition-form flex-col pl-8 py-6">
            <div class="condition-select-field-name flex mb-6">
              <mat-form-field appearance="outline">
                <mat-label> Field Name </mat-label>
                <mat-select>
                  <mat-option value="1"> File option </mat-option>
                  <mat-option value="2"> File option </mat-option>
                  <mat-option value="3"> File option </mat-option>
                </mat-select>
              </mat-form-field>
            </div>
            <div class="condition-select-comparison-type flex mb-6">
              <mat-form-field appearance="outline">
                <mat-label> Comparison Type </mat-label>
                <mat-select>
                  <mat-option value="not"> Is not </mat-option>
                  <mat-option value="is"> Is </mat-option>
                </mat-select>
              </mat-form-field>
            </div>
            <div
              class="condition-select-previous-field-type condition-button-icon-custom flex items-center mb-6"
            >
              <mat-form-field
                appearance="outline"
                *ngIf="switchConditionPreviousFields; else fieldCustomValue"
              >
                <mat-label> Previous Fields </mat-label>
                <mat-select>
                  <mat-option value="1">File option</mat-option>
                  <mat-option value="2">File option</mat-option>
                </mat-select>
              </mat-form-field>
              <ng-template #fieldCustomValue>
                <mat-form-field appearance="outline">
                  <mat-label> Custom Value </mat-label>
                  <input matInput />
                </mat-form-field>
              </ng-template>
              <div class="condition-switch-button">
                <button
                  mat-stroked-button
                  (click)="
                    switchConditionPreviousFields =
                      !switchConditionPreviousFields
                  "
                >
                  <i
                    class="fa-solid text-accent-500 fa-xl"
                    [class]="[
                      isTypeSelectPreviousFields
                        ? 'fa-keyboard'
                        : 'fa-angle-down'
                    ]"
                  ></i>
                </button>
              </div>
            </div>
            <div class="condition-buttons-action mb-6 space-x-2">
              <button mat-button>Cancel</button>
              <button mat-button color="accent">Save</button>
            </div>
          </section>
        </ng-template>
      </section>
      <section
        class="rules-right-side-actions w-full"
        *ngIf="ruleSelectedMenu === 'rules'"
      >
        <div
          class="title h-14 flex justify-between items-center bg-secondary-50 pl-8 pr-6"
        >
          <p class="tracking-tight text-sm">Actions</p>
        </div>
        <div
          class="action-buttons-container border-b border-secondary-50 pt-8 pb-10 overflow-x-auto"
        >
          <mat-button-toggle-group
            name="actionButtons"
            aria-label="Action buttons"
            value="0"
            class="button-group"
          >
            <mat-button-toggle
              value="0"
              data-testid="toggle-button-flow"
              id="toggle-button-flow"
              >Flow</mat-button-toggle
            >
            <mat-button-toggle
              value="1"
              data-testid="toggle-button-container"
              id="toggle-button-container"
              >Container</mat-button-toggle
            >
            <mat-button-toggle
              value="2"
              data-testid="toggle-button-user"
              id="toggle-button-user"
              >User</mat-button-toggle
            >
            <mat-button-toggle
              value="3"
              data-testid="toggle-button-notifications"
              id="toggle-button-notifications"
              >Notifications</mat-button-toggle
            >
            <mat-button-toggle
              value="4"
              data-testid="toggle-button-integrations"
              id="toggle-button-integrations"
              >Integrations</mat-button-toggle
            >
            <mat-button-toggle
              value="5"
              data-testid="toggle-button-advanced"
              id="toggle-button-advanced"
              >Advanced</mat-button-toggle
            >
          </mat-button-toggle-group>
        </div>
      </section>
    </div>
  </div>
</ng-template>
