<!--Loading the widget-->
<app-loading-widget
  *ngIf="isLoading"
  id="app-loading-indicator"
></app-loading-widget>

<!--Show error in the widget-->
<app-error-widget
  *ngIf="failedLoadWidget"
  id="error-load-widget"
  [errorMessage]="'Unable to retrieve document data'"
  (tryAgain)="getDocumentWidget()"
>
</app-error-widget>
<!-- Header widget -->
<div
  class="w-full p-2 flex flex-col h-full"
  *ngIf="!isLoading && !failedLoadWidget"
>
  <!--  Header Container -->
  <div>
    <div class="flex justify-between items-center">
      <h3 *ngIf="dataDocumentWidget" class="font-semibold truncate">
        {{ dataDocumentWidget.documentName }}
      </h3>
      <div *ngIf="editMode" id="gear-icon-document">
        <button
          mat-icon-button
          [disabled]="isDrawerOpen && drawerContext !== 'menuDashboard'"
          id="toggle-edit-document"
          data-testid="toggle-edit-document"
          class="text-secondary-500"
          (click)="toggleEditDocument()"
        >
          <i class="fas fa-cog text-[16px]"></i>
        </button>
      </div>
      <div
        *ngIf="
          dataDocumentWidget.stations.length > 1 && !editMode;
          else singleStationLink
        "
      >
        <button
          mat-icon-button
          [matMenuTriggerFor]="stationMenu"
          id="show-more-stations"
          data-testid="show-more-stations"
        >
          <i class="fas fa-ellipsis-h text-secondary-500 text-[16px]"></i>
        </button>
        <mat-menu #stationMenu>
          <div
            *ngFor="let station of dataDocumentWidget.stations; let i = index"
          >
            <div
              mat-menu-item
              [id]="'go-to-document-station-' + i"
              [attr.data-testid]="'go-to-document-station-' + i"
              (click)="goToDocument(station.stationRithmId)"
            >
              <i
                class="fas fa-external-link-alt text-[16px] text-secondary-500"
              ></i>
              {{ station.stationName }}
            </div>
          </div>
        </mat-menu>
      </div>
      <ng-template #singleStationLink>
        <button
          *ngIf="!editMode"
          mat-icon-button
          id="go-to-document-page-single"
          (click)="goToDocument(dataDocumentWidget.stations[0].stationRithmId)"
        >
          <i
            class="fas fa-external-link-alt text-[16px] text-secondary-500"
          ></i>
        </button>
      </ng-template>
    </div>
  </div>

  <!--List of the questions-->
  <div class="w-full flex h-full overflow-auto scrollbar">
    <div class="w-full h-full" *ngIf="dataDocumentWidget">
      <!-- Display questions by columns or all questions if columns is empty-->
      <ng-container
        *ngIf="
          documentColumns.length;
          then displayQuestionsWithDataColumns;
          else displayQuestionsDefault
        "
      >
      </ng-container>

      <div
        class="text-center py-2 text-sm"
        *ngIf="!dataDocumentWidget.questions.length"
      >
        This document doesn't have any questions.
      </div>
    </div>
  </div>
</div>

<!--Display questions with list of the columns-->
<ng-template #displayQuestionsWithDataColumns>
  <ng-container *ngFor="let column of documentColumns">
    <ng-container *ngFor="let questionList of dataDocumentWidget.questions">
      <ng-container *ngFor="let questions of questionList.questions">
        <ng-container *ngIf="questions.rithmId === column.questionId">
          <ng-container
            *ngTemplateOutlet="
              questionColumn;
              context: { $implicit: questions }
            "
          ></ng-container>
        </ng-container>
      </ng-container>
    </ng-container>
  </ng-container>
</ng-template>

<!--Display questions default if columns is empty-->
<ng-template #displayQuestionsDefault>
  <ng-container *ngFor="let questionList of dataDocumentWidget.questions">
    <ng-container *ngFor="let questions of questionList.questions">
      <ng-container
        *ngTemplateOutlet="questionColumn; context: { $implicit: questions }"
      ></ng-container>
    </ng-container>
  </ng-container>
</ng-template>

<!--Question column-->
<ng-template #questionColumn let-questions>
  <div class="py-3 border-b border-b-secondary-200">
    <p class="font-semibold text-sm">
      {{
      questions.questionType === 'instructions'
        ? 'Instruction'
        : questions.prompt
      }}
    </p>

    <div [ngSwitch]="questions.questionType">
      <p *ngSwitchCase="questionFieldType.CheckList" class="pt-3 text-sm">
        <span *ngFor="let answer of questions.answer?.asArray">
          <i
            class="fas"
            [ngClass]="
              answer.isChecked
                ? 'fa-check-square text-accent-500'
                : 'fa-square text-secondary-500'
            "
          ></i>
          - {{ answer.value }}<br />
        </span>
      </p>
      <p *ngSwitchCase="questionFieldType.MultiSelect" class="pt-3 text-sm">
        <span *ngFor="let answer of questions.answer?.asArray">
          <i
            class="fas"
            [ngClass]="
              answer.isChecked
                ? 'fa-check-square text-accent-500'
                : 'fa-square text-secondary-500'
            "
          ></i>
          -
          {{ answer.value }}
          <br />
        </span>
      </p>
      <p *ngSwitchCase="questionFieldType.Select" class="pt-3 text-sm">
        <span *ngFor="let answer of questions.answer?.asArray">
          <i
            class="fas"
            [ngClass]="
              answer.isChecked
                ? 'fa-check-square text-accent-500'
                : 'fa-square text-secondary-500'
            "
          ></i>
          - {{ answer.value }} <br />
        </span>
      </p>
      <p *ngSwitchCase="'instructions'" class="pt-3 text-sm">
        {{ questions.prompt }}
      </p>
      <p *ngSwitchDefault class="pt-3 text-sm">
        {{ questions.answer?.value || "This question doesn't have an answer." }}
      </p>
    </div>
  </div>
</ng-template>
