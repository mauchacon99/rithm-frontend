<!--Loading the widget-->
<app-loading-widget
  *ngIf="isLoading"
  id="app-loading-indicator"
></app-loading-widget>

<!--Show error in the widget-->
<app-error-widget
  *ngIf="failedLoadWidget"
  id="error-load-widget"
  [errorMessage]="'Unable to retrieve station data'"
  (tryAgain)="getStationWidgetDocuments()"
>
</app-error-widget>

<!-- station widget -->
<div
  *ngIf="!isLoading && !failedLoadWidget && !isDocument"
  id="show-docs"
  class="h-full w-full"
>
  <!-- Header widget -->
  <div class="w-full p-2 flex flex-col h-full">
    <!--  Header Container  -->
    <div class="m-2">
      <div class="flex justify-between items-center">
        <h3 *ngIf="dataStationWidget" class="font-semibold truncate">
          {{ dataStationWidget.stationName }}
        </h3>
        <div *ngIf="dataStationWidget && !editMode">
          <button
            *ngIf="dataStationWidget.documentGeneratorStatus === 'Manual'"
            mat-stroked-button
            color="accent"
            data-testid="create-new-document"
            id="create-new-document"
            (click)="createNewDocument()"
          >
            New Document <i class="fas fa-plus"></i>
          </button>
          <div
            *ngIf="displayDocumentError"
            class="text-error-500 text-xs p-0.5"
            data-testid="create-document-error"
            id="create-document-error"
          >
            Document not created!
          </div>
        </div>
        <div *ngIf="editMode" id="gear-icon">
          <button
            mat-icon-button
            [disabled]="isDrawerOpen && drawerContext === 'stationWidget'"
            (click)="toggleEditStation()"
            id="toggle-edit-station"
            data-testid="toggle-edit-station"
            class="text-secondary-500"
          >
            <i class="fas fa-cog text-[16px]"></i>
          </button>
        </div>
      </div>
    </div>
    <div class="flex-grow overflow-auto scrollbar">
      <div *ngIf="dataStationWidget">
        <div
          *ngIf="!dataStationWidget.documents.length"
          class="text-center my-4"
          id="no-docs-message"
        >
          No documents found in station.
        </div>
        <ng-container *ngIf="dataStationWidget.documents.length">
          <ng-container
            *ngTemplateOutlet="tableDocuments; context: dataStationWidget"
          ></ng-container>
        </ng-container>
      </div>
    </div>
  </div>
</div>

<!--Document detail-->
<div
  class="h-full p-2 overflow-auto"
  *ngIf="isDocument && !isLoading"
  id="document-detail"
>
  <!--  Header -->
  <div class="flex justify-between items-center">
    <button
      [disabled]="
        documentComponent
          ? documentComponent.documentLoading === undefined
            ? true
            : documentComponent.documentLoading
          : true
      "
      mat-icon-button
      (click)="viewDocument('', true)"
      id="return-list-documents"
      data-testid="return-list-documents"
    >
      <i
        [ngClass]="{
          'text-secondary-300': documentComponent
            ? documentComponent.documentLoading === undefined
              ? true
              : documentComponent.documentLoading
            : true
        }"
        class="fas text-secondary-500 fa-arrow-left text-lg"
      ></i>
    </button>
    <button
      mat-icon-button
      (click)="toggleExpandWidget()"
      id="expand-document"
      data-testid="expand-document"
    >
      <i
        [ngClass]="isExpandWidget ? 'fa-compress-alt' : 'fa-expand-alt'"
        class="fas text-secondary-500 text-lg"
      ></i>
    </button>
  </div>
  <!--  Document component -->
  <div class="container-document">
    <app-document
      [isWidget]="true"
      (returnDocumentsWidget)="viewDocument('', $event)"
      [documentRithmIdWidget]="documentIdSelected"
      [stationRithmIdWidget]="stationRithmId"
    ></app-document>
  </div>
</div>

<!--Table documents-->
<ng-template #tableDocuments let-documents="documents">
  <table mat-table [dataSource]="documents" class="mat-elevation-z8 w-full">
    <ng-container
      [matColumnDef]="
        column?.questionId ? column.questionId || '' : column.name
      "
      *ngFor="let column of columnsAllField"
    >
      <ng-container *ngIf="!column?.questionId">
        <th mat-header-cell *matHeaderCellDef>
          <span class="font-semibold truncate">{{
            getColumnBasicName(column.name) | uppercase
          }}</span>
        </th>
        <td mat-cell *matCellDef="let element" class="min-w-[150px] px-2">
          <ng-container
            *ngTemplateOutlet="
              tableColumnBasic;
              context: { column: column?.name, document: element }
            "
          >
          </ng-container>
        </td>
      </ng-container>
      <ng-container *ngIf="column?.questionId">
        <th mat-header-cell *matHeaderCellDef>
          <span class="font-semibold truncate">{{
            column?.name | uppercase
          }}</span>
        </th>
        <td mat-cell *matCellDef="let element" class="min-w-[150px] px-2">
          <ng-container
            *ngTemplateOutlet="
              tableColumnQuestion;
              context: { column: column?.questionId, document: element }
            "
          >
          </ng-container>
        </td>
      </ng-container>
    </ng-container>

    <ng-container *ngIf="!columnsAllField.length" [matColumnDef]="'name'">
      <th mat-header-cell *matHeaderCellDef class="font-semibold truncate">
        DOCUMENT
      </th>
      <td mat-cell class="min-w-[150px]" *matCellDef="let element">
        {{ element?.name }}
      </td>
    </ng-container>

    <ng-container [matColumnDef]="'viewDocument'">
      <th mat-header-cell *matHeaderCellDef></th>
      <td mat-cell *matCellDef="let element">
        <div class="text-right w-full">
          <button
            (click)="viewDocument(element?.rithmId)"
            mat-icon-button
            data-testid="show-document-widget"
            id="show-document-widget"
            [disabled]="editMode"
          >
            <i class="fas text-lg text-secondary-400 fa-angle-double-right"></i>
          </button>
        </div>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="columnsToDisplayTable"></tr>
    <tr mat-row *matRowDef="let row; columns: columnsToDisplayTable"></tr>
  </table>
</ng-template>

<!--template for show columns basic of the document-->
<ng-template #tableColumnBasic let-column="column" let-document="document">
  <div [ngSwitch]="column">
    <div *ngSwitchCase="columnsDocumentInfo.AssignedUser">
      <div *ngIf="document?.assignedUser">
        <div class="flex flex-col justify-center">
          <app-user-avatar
            [firstName]="document?.assignedUser?.firstName"
            [lastName]="document?.assignedUser?.lastName"
          >
          </app-user-avatar>
        </div>
      </div>
      <div *ngIf="!document?.assignedUser" class="text-xs">None</div>
    </div>
    <div *ngSwitchCase="columnsDocumentInfo.TimeInStation" class="text-xs">
      {{ getElapsedTime(document?.flowedTimeUTC) }}
    </div>
    <div *ngSwitchCase="columnsDocumentInfo.LastUpdated" class="text-xs">
      {{ getElapsedTime(document?.lastUpdatedUTC) }}
    </div>
    <div *ngSwitchCase="columnsDocumentInfo.Priority" class="text-xs">
      <i class="fas text-lg text-secondary-400 fa-exclamation-triangle"></i>
    </div>
    <div *ngSwitchDefault class="text-xs">
      {{ document[column] }}
    </div>
  </div>
</ng-template>

<!--Template for show questions columns of the document-->
<ng-template #tableColumnQuestion let-column="column" let-document="document">
  <ng-container *ngFor="let questions of document?.questions[0]?.questions">
    <div *ngIf="questions?.rithmId === column">
      <div [ngSwitch]="questions?.questionType">
        <p *ngSwitchCase="questionFieldType.CheckList" class="text-xs">
          <span *ngFor="let answer of questions?.answer?.asArray">
            <i
              class="fas"
              [ngClass]="
                answer?.isChecked
                  ? 'fa-check-square text-accent-500'
                  : 'fa-square text-secondary-500'
              "
            ></i>
            - {{ answer?.value }}<br />
          </span>
        </p>
        <p *ngSwitchCase="questionFieldType.MultiSelect" class="text-xs">
          <span *ngFor="let answer of questions?.answer?.asArray">
            <i
              class="fas"
              [ngClass]="
                answer?.isChecked
                  ? 'fa-check-square text-accent-500'
                  : 'fa-square text-secondary-500'
              "
            ></i>
            -
            {{ answer?.value }}
            <br />
          </span>
        </p>
        <p *ngSwitchCase="questionFieldType.Select" class="text-xs">
          <span *ngFor="let answer of questions?.answer?.asArray">
            <i
              class="fas"
              [ngClass]="
                answer?.isChecked
                  ? 'fa-check-square text-accent-500'
                  : 'fa-square text-secondary-500'
              "
            ></i>
            - {{ answer?.value }} <br />
          </span>
        </p>
        <p *ngSwitchCase="'instructions'" class="text-xs">
          {{ questions?.prompt }}
        </p>
        <p *ngSwitchDefault class="text-xs">
          {{ questions?.answer?.value || 'NA' }}
        </p>
      </div>
    </div>
  </ng-container>
</ng-template>
